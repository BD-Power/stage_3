version: "3.9"

services:
  # 1. ActiveMQ Broker
  activemq:
    image: rmohr/activemq:5.15.9
    container_name: activemq
    ports:
      - "8161:8161"
    environment:
      ACTIVEMQ_ADMIN_LOGIN: admin
      ACTIVEMQ_ADMIN_PASSWORD: admin
    networks:
      - search_network
    expose:
      - 61616

  # 2. Crawler 1
  crawler1:
    build:
      context: .
      dockerfile: Dockerfile.crawler
    container_name: crawler1
    depends_on:
      - activemq
    environment:
      - CRAWLER_ID=crawler1
      - CRAWLER_PEERS=crawler2
      - SPRING_ACTIVEMQ_BROKER_URL=tcp://activemq:61616
    volumes:
      - ./datalake:/data
    ports:
      - "8081:8081"
    networks:
      - search_network

  # 3. Crawler 2
  crawler2:
    build:
      context: .
      dockerfile: Dockerfile.crawler
    container_name: crawler2
    depends_on:
      - activemq
    environment:
      - CRAWLER_ID=crawler2
      - CRAWLER_PEERS=crawler1
      - SPRING_ACTIVEMQ_BROKER_URL=tcp://activemq:61616
    volumes:
      - ./datalake:/data
    networks:
      - search_network

  # 4. Indexer Service
  indexer-service:
    build:
      context: .
      dockerfile: Dockerfile.indexer
    depends_on:
      - activemq
    environment:
      - SPRING_ACTIVEMQ_BROKER_URL=tcp://activemq:61616
      - HZ_CLUSTER_NAME=bd-search-cluster
    volumes:
      - ./datalake:/data
    expose:
      - 8080
      - 5701
    networks:
      - search_network

  # 5. Search Services
  search1:
    build:
      context: .
      dockerfile: Dockerfile.search
    depends_on:
      - indexer-service
    environment:
      - HZ_CLUSTER_NAME=bd-search-cluster
    expose:
      - 8080
      - 5701
    networks:
      - search_network

  search2:
    build:
      context: .
      dockerfile: Dockerfile.search
    depends_on:
      - indexer-service
    environment:
      - HZ_CLUSTER_NAME=bd-search-cluster
    expose:
      - 8080
      - 5701
    networks:
      - search_network

  # 6. Nginx Load Balancer
  nginx:
    image: nginx:latest
    container_name: nginx-lb
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - search1
      - search2
    networks:
      - search_network

volumes:
  datalake_data:

networks:
  search_network:
    driver: bridge